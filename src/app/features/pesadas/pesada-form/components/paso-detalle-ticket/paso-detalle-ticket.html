<div class="section-header d-flex justify-content-between mb-3">
  <div>
    <h6 class="section-title mb-1">Detalle del ticket</h6>
    <p class="section-subtitle mb-0">
      Registra las pesadas del ticket y asocia las taras por empaque a cada una de ellas.
    </p>

    <div class="alert alert-warning mt-2 mb-0" *ngIf="locked">
      El ticket está en proceso de guardado. Espera un momento para continuar.
    </div>
  </div>

  <button
    type="button"
    class="ux-btn ux-btn--green"
    (click)="onAdd()"
    [disabled]="locked"
  >
    <span class="material-symbols-rounded">add</span>
    <span>Agregar pesada</span>
  </button>
</div>

<!-- =========================
     CABECERA (6 inputs)
========================= -->
<div class="totals-bar" [formGroup]="formGroup">
  <div class="row g-3 align-items-end">
    <!-- 1 -->
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <label class="total-label mb-1">Cantidad ítems</label>
      <input
        type="text"
        class="form-control ux-input border-0 border-bottom rounded-0 bg-transparent px-0"
        [value]="(totales?.cantidadItems ?? 0) | number: '2.0-0'"
        disabled
        readonly
      />
    </div>

    <!-- 2 -->
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <label class="total-label mb-1">Cantidad pallets</label>
      <input
        type="text"
        class="form-control ux-input border-0 border-bottom rounded-0 bg-transparent px-0"
        [value]="(totales?.cantidadPallets ?? totales?.cantidadPallet ?? 0) | number: '2.0-0'"
        disabled
        readonly
      />
    </div>

    <!-- 3 -->
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <label class="total-label mb-1">Peso pallets (Kg)</label>
      <input
        type="text"
        class="form-control ux-input border-0 border-bottom rounded-0 bg-transparent px-0"
        [value]="(totales?.pesoPalletsKg ?? 0) | number: '1.2-2'"
        disabled
        readonly
      />
    </div>

    <!-- 4 -->
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <label class="total-label mb-1">Total peso bruto (Kg)</label>
      <input
        type="text"
        class="form-control ux-input border-0 border-bottom rounded-0 bg-transparent px-0"
        [value]="(totales?.totalPesoBruto ?? 0) | number: '1.2-2'"
        disabled
        readonly
      />
    </div>

    <!-- 5 -->
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <label class="total-label mb-1">Total tara (Kg)</label>
      <input
        type="text"
        class="form-control ux-input border-0 border-bottom rounded-0 bg-transparent px-0"
        [value]="(totales?.totalTara ?? 0) | number: '1.2-2'"
        disabled
        readonly
      />
    </div>

    <!-- 6 -->
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <label class="total-label mb-1">Sub total peso neto (Kg)</label>
      <input
        type="text"
        class="form-control ux-input border-0 border-bottom rounded-0 bg-transparent px-0"
        [value]="(totales?.subtotalPesoNeto ?? 0) | number: '1.2-2'"
        disabled
        readonly
      />
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-hover ux-table m-0">
    <thead class="ux-table__head">
      <tr>
        <th class="ux-col-idx">Item</th>
        <th>Producto</th>
        <th>Balanza</th>
        <th>Tipo-Pesada</th>
        <th class="text-end">Peso bruto (Kg)</th>
        <th class="text-end">Tara</th>
        <th class="text-end">Peso neto (Kg)</th>
        <th>Observaciones</th>
        <th>Requiere Tara</th>
        <th>Tiene Tara</th>
        <th>Estado</th>
        <th class="ux-col-actions">Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let p of pesadas; let i = index">
        <td class="ux-col-idx" [attr.data-label]="'Item'">
          {{ i + 1 | number: '2.0-0' }}
        </td>
        <td [attr.data-label]="'Producto'">{{ p.producto }}</td>
        <td [attr.data-label]="'Balanza'">{{ p.balanza }}</td>
        <td [attr.data-label]="'Tipo-Pesada'">PALLET CON PRODUCTO</td>

        <td class="text-end" [attr.data-label]="'Peso bruto (Kg)'">
          {{ p.pesoBrutoKg | number: '1.2-2' }}
        </td>
        <td class="text-end" [attr.data-label]="'Tara (Kg)'">
          {{ p.taraTotalKg | number: '1.2-2' }}
        </td>
        <td class="text-end" [attr.data-label]="'Peso neto (Kg)'">
          {{ p.pesoNetoKg | number: '1.2-2' }}
        </td>

        <td [attr.data-label]="'Observaciones'">{{ p.observaciones || '-' }}</td>

        <!-- ✅ Requiere Tara (TEXTO) -->
        <td [attr.data-label]="'Requiere Tara'">
          <span
            class="ux-yesno"
            [ngClass]="p.tieneTara ? 'ux-yesno--yes' : 'ux-yesno--no'"
          >
            {{ p.tieneTara ? 'SI' : 'NO' }}
          </span>
        </td>

        <!-- ✅ Tiene Tara (TEXTO) -->
        <td [attr.data-label]="'Tiene Tara'">
          <span
            class="ux-yesno"
            [ngClass]="p.tieneTara ? 'ux-yesno--yes' : 'ux-yesno--no'"
          >
            {{ p.tieneTara ? 'SI' : 'NO' }}
          </span>
        </td>

        <td [attr.data-label]="'Estado'">
          <span
            class="status-pill"
            [ngClass]="{
              'status-pill--registro': p.estado === 'Activo',
              'status-pill--cerrada': p.estado === 'Inactivo'
            }"
          >
            {{ p.estado || 'Activo' }}
          </span>
        </td>

        <td class="ux-col-actions" [attr.data-label]="'Acciones'">
          <button
            type="button"
            class="ux-icon-btn ux-icon-btn--medium"
            (click)="onManageTaras(i)"
            title="Gestionar taras"
            [disabled]="locked"
          >
            <span class="material-symbols-rounded">inventory_2</span>
          </button>

          <button
            type="button"
            class="ux-icon-btn ux-icon-btn--medium"
            (click)="onEdit(i)"
            title="Editar pesada"
            [disabled]="locked"
          >
            <span class="material-symbols-rounded">edit</span>
          </button>

          <button
            type="button"
            class="ux-icon-btn ux-icon-btn--medium"
            (click)="onDelete(i)"
            title="Eliminar"
            [disabled]="locked"
          >
            <span class="material-symbols-rounded">delete</span>
          </button>
        </td>
      </tr>

      <tr *ngIf="(pesadas?.length || 0) === 0">
        <td colspan="12" class="text-center py-3">
          Aún no se han registrado pesadas para este ticket.
        </td>
      </tr>
    </tbody>
  </table>
</div>
