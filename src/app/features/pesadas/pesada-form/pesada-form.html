<div class="ux-scope">
  <div class="card ux-card p-3">
    <!-- HEADER -->
    <div class="ux-form-header">
      <div>
        <h5 class="ux-title mb-1">Ticket de balanza - Nuevo</h5>
        <p class="ux-subtitle mb-0">
          Registro paso a paso del ticket de balanza, documentos relacionados,
          datos de transporte y pesadas asociadas.
        </p>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button
          type="button"
          class="ux-btn ux-btn--blue"
          (click)="guardarEncabezado()"
          [disabled]="isSavingHeader"
        >
          <ng-container *ngIf="!isSavingHeader">
            <span class="material-symbols-rounded">save</span>
            <span>Guardar encabezado</span>
          </ng-container>
          <ng-container *ngIf="isSavingHeader">
            <span
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            <span>Guardando…</span>
          </ng-container>
        </button>

        <button
          type="button"
          class="ux-btn ux-btn--primary"
          *ngIf="currentStep === maxStep"
          (click)="guardarTicketCompleto()"
          [disabled]="isSavingFull"
        >
          <ng-container *ngIf="!isSavingFull">
            <span class="material-symbols-rounded">done_all</span>
            <span>Guardar ticket</span>
          </ng-container>
          <ng-container *ngIf="isSavingFull">
            <span
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            <span>Guardando…</span>
          </ng-container>
        </button>
      </div>
    </div>

    <!-- STEPPER -->
    <app-stepper-nav
      class="mb-3"
      [steps]="steps"
      [currentStep]="currentStep"
      (stepChange)="onStepChange($event)"
    ></app-stepper-nav>

    <!-- FORM -->
    <form
      [formGroup]="ticketForm"
      novalidate
      autocomplete="off"
      class="step-form"
    >
      <div class="step-content" [ngSwitch]="currentStep">
        <!-- PASO 1 -->
        <div *ngSwitchCase="1" class="step-panel">
          <app-paso-datos-operacion
            [formGroup]="datosOperacion"
            [stations]="stations"
            [operations]="operations"
            [minFechaEmision]="minFechaEmision"
            [maxFechaEmision]="maxFechaEmision"
            (stationChange)="onChangeOperationStation()"
          ></app-paso-datos-operacion>
        </div>

        <!-- PASO 2 -->
        <div *ngSwitchCase="2" class="step-panel">
          <app-paso-origen-destino
            [formGroup]="origenDestino"
            [originStations]="originStations"
            [destinationStations]="destinationStations"
          ></app-paso-origen-destino>
        </div>

        <!-- PASO 3: DOCUMENTOS RELACIONADOS -->
        <div *ngSwitchCase="3" class="step-panel">
          <app-paso-documentos
            [documentos]="documentos"
            (addDocumento)="addDocumentoRelacionado()"
            (editDocumento)="editDocumentoRelacionado(documentos[$event], $event)"
            (deleteDocumento)="deleteDocumentoRelacionado($event)"
          ></app-paso-documentos>
        </div>

        <!-- PASO 4: DATOS DEL TRANSPORTE -->
        <div *ngSwitchCase="4" class="step-panel">
          <app-paso-transporte
            [formGroup]="transporte"
            [carriers]="carriers"
            [carrierDrivers]="carrierDrivers"
            [carrierTrucks]="carrierTrucks"
            [carrierTrailers]="carrierTrailers"
            [getTruckPlate]="getTruckPlate.bind(this)"
            [getTrailerPlate]="getTrailerPlate.bind(this)"
            (transportistaChange)="onChangeTransportista()"
            (conductorChange)="onChangeConductor()"
          ></app-paso-transporte>
        </div>

        <!-- PASO 5: DETALLE TICKET -->
        <div *ngSwitchCase="5" class="step-panel">
          <app-paso-detalle-ticket
            [formGroup]="detalleTicket"
            [pesadas]="pesadas"
            [totales]="totalesPesadas"
            (addPesada)="addPesada()"
            (editPesada)="editPesada(pesadas[$event], $event)"
            (deletePesada)="deletePesada($event)"
            (manageTaras)="openTarasForPesada(pesadas[$event], $event)"
            (ajusteChange)="onChangeAjusteKg()"
          ></app-paso-detalle-ticket>
        </div>

        <!-- Default -->
        <div *ngSwitchDefault class="step-panel">
          <p class="mb-0">Selecciona un paso para comenzar.</p>
        </div>
      </div>

      <!-- Navegación -->
      <div
        class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2"
      >
        <button
          type="button"
          class="ux-btn ux-btn--blue"
          (click)="prevStep()"
          [disabled]="currentStep === 1"
        >
          <span class="material-symbols-rounded">arrow_back</span>
          <span>Volver</span>
        </button>

        <div class="d-flex flex-wrap gap-2">
          <button
            type="button"
            class="ux-btn ux-btn--green"
            (click)="nextStep()"
            *ngIf="currentStep < maxStep"
          >
            <span>Siguiente</span>
            <span class="material-symbols-rounded">arrow_forward</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
