<div class="ux-scope">
  <div class="card ux-card p-3">
    <!-- HEADER -->
    <div class="ux-form-header">
      <div>
        <h5 class="ux-title mb-1">Ticket de balanza - Nuevo</h5>
        <p class="ux-subtitle mb-0">
          Registro paso a paso del ticket de balanza, documentos relacionados,
          datos de transporte y pesadas asociadas.
        </p>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <!-- Guardar encabezado (hasta paso 4) -->
        <button
          type="button"
          class="ux-btn ux-btn--blue"
          (click)="guardarEncabezado()"
          [disabled]="isSavingHeader"
        >
          <ng-container *ngIf="!isSavingHeader">
            <span class="material-symbols-rounded">save</span>
            <span>Guardar encabezado</span>
          </ng-container>
          <ng-container *ngIf="isSavingHeader">
            <span
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            <span>Guardando…</span>
          </ng-container>
        </button>

        <!-- Guardar ticket completo (solo visible en paso 5) -->
        <button
          type="button"
          class="ux-btn ux-btn--primary"
          *ngIf="currentStep === maxStep"
          (click)="guardarTicketCompleto()"
          [disabled]="isSavingFull"
        >
          <ng-container *ngIf="!isSavingFull">
            <span class="material-symbols-rounded">done_all</span>
            <span>Guardar ticket</span>
          </ng-container>
          <ng-container *ngIf="isSavingFull">
            <span
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            <span>Guardando…</span>
          </ng-container>
        </button>
      </div>
    </div>

    <!-- STEPPER -->
    <div class="stepper mb-3">
      <button
        type="button"
        class="stepper__item"
        [class.stepper__item--active]="currentStep === 1"
        (click)="goToStep(1)"
      >
        <div class="stepper__index">1</div>
        <div class="stepper__content">
          <div class="stepper__label">Datos de operación</div>
          <div class="stepper__hint">Fecha, operación y sede</div>
        </div>
      </button>

      <button
        type="button"
        class="stepper__item"
        [class.stepper__item--active]="currentStep === 2"
        (click)="goToStep(2)"
      >
        <div class="stepper__index">2</div>
        <div class="stepper__content">
          <div class="stepper__label">Origen / Destino</div>
          <div class="stepper__hint">Sede de origen y destino</div>
        </div>
      </button>

      <button
        type="button"
        class="stepper__item"
        [class.stepper__item--active]="currentStep === 3"
        (click)="goToStep(3)"
      >
        <div class="stepper__index">3</div>
        <div class="stepper__content">
          <div class="stepper__label">Documentos relacionados</div>
          <div class="stepper__hint">Guías y comprobantes</div>
        </div>
      </button>

      <button
        type="button"
        class="stepper__item"
        [class.stepper__item--active]="currentStep === 4"
        (click)="goToStep(4)"
      >
        <div class="stepper__index">4</div>
        <div class="stepper__content">
          <div class="stepper__label">Datos del transporte</div>
          <div class="stepper__hint">Empresa, conductor y vehículo</div>
        </div>
      </button>

      <button
        type="button"
        class="stepper__item"
        [class.stepper__item--active]="currentStep === 5"
        (click)="goToStep(5)"
      >
        <div class="stepper__index">5</div>
        <div class="stepper__content">
          <div class="stepper__label">Detalle del ticket</div>
          <div class="stepper__hint">Pesadas y taras</div>
        </div>
      </button>
    </div>

    <!-- FORM -->
    <form
      [formGroup]="ticketForm"
      novalidate
      autocomplete="off"
      class="step-form"
    >
      <div class="step-content" [ngSwitch]="currentStep">
        <!-- PASO 1: DATOS DE OPERACIÓN -->
        <div *ngSwitchCase="1" class="step-panel">
          <div class="section-header">
            <h6 class="section-title mb-1">Datos de operación</h6>
            <p class="section-subtitle mb-0">
              Define la fecha de emisión, el tipo de operación y la sede donde se
              realiza la pesada.
            </p>
          </div>

          <div formGroupName="datosOperacion">
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label class="form-label mb-1 small text-muted">
                  Fecha de emisión
                </label>
                <input
                  type="date"
                  class="form-control ux-input"
                  formControlName="fechaEmision"
                />
              </div>

              <div class="col-md-5 col-12">
                <label class="form-label mb-1 small text-muted">
                  Operación
                </label>
                <div class="ux-select">
                  <select
                    class="form-select ux-input"
                    formControlName="operacion"
                  >
                    <option *ngFor="let op of operacionOptions" [value]="op">
                      {{ op }}
                    </option>
                  </select>
                  <span class="ux-select__icon material-symbols-rounded"
                    >expand_more</span
                  >
                </div>
              </div>

              <div class="col-md-4 col-12">
                <label class="form-label mb-1 small text-muted">
                  Sede de operación
                </label>
                <div class="ux-select">
                  <select
                    class="form-select ux-input"
                    formControlName="sedeOperacion"
                  >
                    <option *ngFor="let s of sedeOptions" [value]="s">
                      {{ s }}
                    </option>
                  </select>
                  <span class="ux-select__icon material-symbols-rounded"
                    >expand_more</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PASO 2: ORIGEN / DESTINO -->
        <div *ngSwitchCase="2" class="step-panel">
          <div class="section-header">
            <h6 class="section-title mb-1">Origen / Destino</h6>
            <p class="section-subtitle mb-0">
              Configura la sede de origen y la sede de destino del producto.
            </p>
          </div>

          <div formGroupName="origenDestino">
            <div class="row g-4">
              <div class="col-md-6 col-12">
                <label class="form-label mb-1 small text-muted">
                  Sede de origen
                </label>
                <div class="ux-select">
                  <select
                    class="form-select ux-input"
                    formControlName="sedeOrigen"
                  >
                    <option *ngFor="let s of sedeOptions" [value]="s">
                      {{ s }}
                    </option>
                  </select>
                  <span class="ux-select__icon material-symbols-rounded"
                    >expand_more</span
                  >
                </div>
              </div>

              <div class="col-md-6 col-12">
                <label class="form-label mb-1 small text-muted">
                  Sede de destino
                </label>
                <div class="ux-select">
                  <select
                    class="form-select ux-input"
                    formControlName="sedeDestino"
                  >
                    <option *ngFor="let s of sedeOptions" [value]="s">
                      {{ s }}
                    </option>
                  </select>
                  <span class="ux-select__icon material-symbols-rounded"
                    >expand_more</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PASO 3: DOCUMENTOS RELACIONADOS -->
        <div *ngSwitchCase="3" class="step-panel">
          <div class="section-header d-flex justify-content-between mb-3">
            <div>
              <h6 class="section-title mb-1">Documentos relacionados</h6>
              <p class="section-subtitle mb-0">
                Agrega las guías de remisión y otros documentos que respaldan el
                movimiento de producto.
              </p>
            </div>

            <button
              type="button"
              class="ux-btn ux-btn--green"
              (click)="addDocumentoRelacionado()"
            >
              <span class="material-symbols-rounded">add</span>
              <span>Agregar documento</span>
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-hover ux-table m-0">
              <thead class="ux-table__head">
                <tr>
                  <th class="ux-col-idx">Item</th>
                  <th>Socio de negocio</th>
                  <th>Tipo doc.</th>
                  <th>Documento</th>
                  <th>Fecha doc.</th>
                  <th>Número documento</th>
                  <th class="text-end">Peso bruto (Kg)</th>
                  <th class="text-end">Peso neto (Kg)</th>
                  <th class="ux-col-actions">Acciones</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let doc of documentos; let i = index">
                  <td class="ux-col-idx" [attr.data-label]="'Item'">
                    {{ i + 1 | number: '2.0-0' }}
                  </td>
                  <td [attr.data-label]="'Socio de negocio'">
                    {{ doc.socioNegocio }}
                  </td>
                  <td [attr.data-label]="'Tipo doc.'">
                    {{ doc.tipoDocumento }}
                  </td>
                  <td [attr.data-label]="'Documento'">
                    {{ doc.documento }}
                  </td>
                  <td [attr.data-label]="'Fecha doc.'">
                    {{ doc.fechaDocumento | date: 'dd/MM/yyyy' }}
                  </td>
                  <td [attr.data-label]="'Número documento'">
                    {{ doc.numeroDocumento }}
                  </td>
                  <td class="text-end" [attr.data-label]="'Peso bruto (Kg)'">
                    {{ doc.pesoBrutoKg | number: '1.2-2' }}
                  </td>
                  <td class="text-end" [attr.data-label]="'Peso neto (Kg)'">
                    {{ doc.pesoNetoKg | number: '1.2-2' }}
                  </td>
                  <td class="ux-col-actions" [attr.data-label]="'Acciones'">
                    <button
                      type="button"
                      class="ux-icon-btn ux-icon-btn--medium"
                      (click)="editDocumentoRelacionado(doc, i)"
                      title="Editar"
                    >
                      <span class="material-symbols-rounded">edit</span>
                    </button>
                    <button
                      type="button"
                      class="ux-icon-btn ux-icon-btn--medium"
                      (click)="deleteDocumentoRelacionado(i)"
                      title="Eliminar"
                    >
                      <span class="material-symbols-rounded">delete</span>
                    </button>
                  </td>
                </tr>

                <tr *ngIf="documentos.length === 0">
                  <td colspan="9" class="text-center py-3">
                    No hay documentos relacionados registrados.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- PASO 4: DATOS DEL TRANSPORTE -->
        <div *ngSwitchCase="4" class="step-panel">
          <div class="section-header">
            <h6 class="section-title mb-1">Datos del transporte</h6>
            <p class="section-subtitle mb-0">
              Completa los datos del transportista, conductor y vehículo que
              realizarán el traslado.
            </p>
          </div>

          <div formGroupName="transporte" class="transport-section">
            <!-- Transportista -->
            <div class="section-block" formGroupName="transportista">
              <h6 class="section-block__title">Datos del transportista</h6>

              <div class="row g-3">
                <div class="col-md-6 col-12">
                  <label class="form-label mb-1 small text-muted">
                    Transportista
                  </label>
                  <div class="ux-select">
                    <select
                      class="form-select ux-input"
                      formControlName="transportistaId"
                    >
                      <option
                        *ngFor="let t of transportistasMock"
                        [value]="t.id"
                      >
                        {{ t.nombre }}
                      </option>
                    </select>
                    <span class="ux-select__icon material-symbols-rounded"
                      >expand_more</span
                    >
                  </div>
                </div>

                <div class="col-md-3 col-6">
                  <label class="form-label mb-1 small text-muted">
                    Tipo documento
                  </label>
                  <div class="ux-select">
                    <select
                      class="form-select ux-input"
                      formControlName="tipoDocumento"
                    >
                      <option value="RUC">RUC</option>
                      <option value="DNI">DNI</option>
                    </select>
                    <span class="ux-select__icon material-symbols-rounded"
                      >expand_more</span
                    >
                  </div>
                </div>

                <div class="col-md-3 col-6">
                  <label class="form-label mb-1 small text-muted">
                    Número documento
                  </label>
                  <input
                    type="text"
                    class="form-control ux-input"
                    formControlName="numeroDocumento"
                  />
                </div>
              </div>
            </div>

            <!-- Conductor -->
            <div class="section-block" formGroupName="conductor">
              <h6 class="section-block__title">Datos del conductor</h6>

              <div class="row g-3">
                <div class="col-md-6 col-12">
                  <label class="form-label mb-1 small text-muted">
                    Conductor
                  </label>
                  <div class="ux-select">
                    <select
                      class="form-select ux-input"
                      formControlName="conductorId"
                    >
                      <option
                        *ngFor="let c of conductoresMock"
                        [value]="c.id"
                      >
                        {{ c.nombre }}
                      </option>
                    </select>
                    <span class="ux-select__icon material-symbols-rounded"
                      >expand_more</span
                    >
                  </div>
                </div>

                <div class="col-md-3 col-6">
                  <label class="form-label mb-1 small text-muted">
                    Tipo documento
                  </label>
                  <div class="ux-select">
                    <select
                      class="form-select ux-input"
                      formControlName="tipoDocumento"
                    >
                      <option value="DNI">DNI</option>
                      <option value="CE">CE</option>
                    </select>
                    <span class="ux-select__icon material-symbols-rounded"
                      >expand_more</span
                    >
                  </div>
                </div>

                <div class="col-md-3 col-6">
                  <label class="form-label mb-1 small text-muted">
                    N° documento
                  </label>
                  <input
                    type="text"
                    class="form-control ux-input"
                    formControlName="numeroDocumento"
                  />
                </div>

                <div class="col-md-3 col-6">
                  <label class="form-label mb-1 small text-muted">
                    Licencia de conducir
                  </label>
                  <input
                    type="text"
                    class="form-control ux-input"
                    formControlName="licenciaConducir"
                  />
                </div>
              </div>
            </div>

            <!-- Vehículo -->
            <div class="section-block" formGroupName="vehiculo">
              <h6 class="section-block__title">Datos del vehículo</h6>

              <div class="row g-3">
                <div class="col-md-4 col-12">
                  <label class="form-label mb-1 small text-muted">
                    Vehículo
                  </label>
                  <div class="ux-select">
                    <select
                      class="form-select ux-input"
                      formControlName="vehiculoId"
                    >
                      <option *ngFor="let v of vehiculosMock" [value]="v.id">
                        {{ v.placa }}
                      </option>
                    </select>
                    <span class="ux-select__icon material-symbols-rounded"
                      >expand_more</span
                    >
                  </div>
                </div>



                <div class="col-md-4 col-12">
                  <label class="form-label mb-1 small text-muted">
                    Trailer
                  </label>
                  <div class="ux-select">
                    <select
                      class="form-select ux-input"
                      formControlName="vehiculoId"
                    >
                      <option *ngFor="let v of trailerMock" [value]="v.id">
                        {{ v.placa }}
                      </option>
                    </select>
                    <span class="ux-select__icon material-symbols-rounded"
                      >expand_more</span
                    >
                  </div>
                </div>



                <!-- <div class="col-md-4 col-6">
                  <label class="form-label mb-1 small text-muted">
                    Placa vehículo
                  </label>
                  <input
                    type="text"
                    class="form-control ux-input"
                    formControlName="placaVehiculo"
                  />
                </div> -->

                <!-- <div class="col-md-4 col-6">
                  <label class="form-label mb-1 small text-muted">
                    Placa tráiler
                  </label>
                  <input
                    type="text"
                    class="form-control ux-input"
                    formControlName="placaTrailer"
                  />
                </div> -->
              </div>
            </div>
          </div>
        </div>

        <!-- PASO 5: DETALLE DEL TICKET (PESADAS) -->
        <div *ngSwitchCase="5" class="step-panel">
          <div class="section-header d-flex justify-content-between mb-3">
            <div>
              <h6 class="section-title mb-1">Detalle del ticket</h6>
              <p class="section-subtitle mb-0">
                Registra las pesadas del ticket y asocia las taras por empaque a
                cada una de ellas.
              </p>
            </div>

            <button
              type="button"
              class="ux-btn ux-btn--green"
              (click)="addPesada()"
            >
              <span class="material-symbols-rounded">add</span>
              <span>Agregar pesada</span>
            </button>
          </div>

          <!-- TOTAlES -->
          <div class="totals-bar" formGroupName="detalleTicket">
            <div class="total-box">
              <div class="total-label">Cantidad ítems</div>
              <div class="total-value">
                {{ totalesPesadas.cantidadItems || 0 }}
              </div>
            </div>

            <div class="total-box">
              <div class="total-label">Total peso bruto (Kg)</div>
              <div class="total-value">
                {{ totalesPesadas.totalPesoBruto | number: '1.2-2' }}
              </div>
            </div>

            <div class="total-box">
              <div class="total-label">Total tara (Kg)</div>
              <div class="total-value">
                {{ totalesPesadas.totalTara | number: '1.2-2' }}
              </div>
            </div>

            <div class="total-box">
              <div class="total-label">Subtotal peso neto (Kg)</div>
              <div class="total-value">
                {{ totalesPesadas.subtotalPesoNeto | number: '1.2-2' }}
              </div>
            </div>

            <div class="total-box total-box--input">
              <label class="total-label mb-1">
                Ajuste (Kg)
              </label>
              <input
                type="number"
                class="form-control ux-input total-input"
                formControlName="ajusteKg"
                (change)="onChangeAjusteKg()"
              />
            </div>

            <div class="total-box">
              <div class="total-label">Diferencia ajuste (Kg)</div>
              <div class="total-value">
                {{ totalesPesadas.diferenciaAjuste | number: '1.2-2' }}
              </div>
            </div>

            <div class="total-box">
              <div class="total-label">Total peso neto (Kg)</div>
              <div class="total-value total-value--highlight">
                {{ totalesPesadas.totalPesoNeto | number: '1.2-2' }}
              </div>
            </div>
          </div>

          <!-- TABLA DE PESADAS -->
          <div class="table-responsive">
            <table class="table table-hover ux-table m-0">
              <thead class="ux-table__head">
                <tr>
                  <th class="ux-col-idx">Item</th>
                  <th>Producto</th>
                  <th>Balanza</th>
                  <th class="text-end">Peso bruto (Kg)</th>
                  <th class="text-end">Tara (Kg)</th>
                  <th class="text-end">Peso neto (Kg)</th>
                  <th>Observaciones</th>
                  <th>Tara</th>
                  <th>Estado</th>
                  <th class="ux-col-actions">Acciones</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let p of pesadas; let i = index">
                  <td class="ux-col-idx" [attr.data-label]="'Item'">
                    {{ i + 1 | number: '2.0-0' }}
                  </td>
                  <td [attr.data-label]="'Producto'">
                    {{ p.producto }}
                  </td>
                  <td [attr.data-label]="'Balanza'">
                    {{ p.balanza }}
                  </td>
                  <td class="text-end" [attr.data-label]="'Peso bruto (Kg)'">
                    {{ p.pesoBrutoKg | number: '1.2-2' }}
                  </td>
                  <td class="text-end" [attr.data-label]="'Tara (Kg)'">
                    {{ p.taraTotalKg | number: '1.2-2' }}
                  </td>
                  <td class="text-end" [attr.data-label]="'Peso neto (Kg)'">
                    {{ p.pesoNetoKg | number: '1.2-2' }}
                  </td>
                  <td [attr.data-label]="'Observaciones'">
                    {{ p.observaciones || '-' }}
                  </td>
                  <td [attr.data-label]="'Tara'">
                    <span
                      class="ux-badge"
                      [class.ux-badge--ok]="p.tieneTara"
                      [class.ux-badge--bad]="!p.tieneTara"
                    >
                      {{ p.tieneTara ? 'SI' : 'NO' }}
                    </span>
                  </td>
                  <td [attr.data-label]="'Estado'">
                    <span
                      class="status-pill"
                      [ngClass]="{
                        'status-pill--registro': p.estado === 'EN REGISTRO',
                        'status-pill--cerrada': p.estado === 'CERRADA',
                        'status-pill--anulada': p.estado === 'ANULADA'
                      }"
                    >
                      {{ p.estado || 'EN REGISTRO' }}
                    </span>
                  </td>
                  <td class="ux-col-actions" [attr.data-label]="'Acciones'">
                    <button
                      type="button"
                      class="ux-icon-btn ux-icon-btn--medium"
                      (click)="openTarasForPesada(p, i)"
                      title="Gestionar taras"
                    >
                      <span class="material-symbols-rounded"
                        >inventory_2</span
                      >
                    </button>

                    <button
                      type="button"
                      class="ux-icon-btn ux-icon-btn--medium"
                      (click)="editPesada(p, i)"
                      title="Editar pesada"
                    >
                      <span class="material-symbols-rounded">edit</span>
                    </button>

                    <button
                      type="button"
                      class="ux-icon-btn ux-icon-btn--medium"
                      (click)="deletePesada(i)"
                      title="Eliminar"
                    >
                      <span class="material-symbols-rounded">delete</span>
                    </button>
                  </td>
                </tr>

                <tr *ngIf="pesadas.length === 0">
                  <td colspan="10" class="text-center py-3">
                    Aún no se han registrado pesadas para este ticket.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Default (seguridad) -->
        <div *ngSwitchDefault class="step-panel">
          <p class="mb-0">Selecciona un paso para comenzar.</p>
        </div>
      </div>

      <!-- Navegación de pasos -->
      <div
        class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2"
      >
        <button
          type="button"
          class="ux-btn ux-btn--blue"
          (click)="prevStep()"
          [disabled]="currentStep === 1"
        >
          <span class="material-symbols-rounded">arrow_back</span>
          <span>Volver</span>
        </button>

        <div class="d-flex flex-wrap gap-2">
          <button
            type="button"
            class="ux-btn ux-btn--green"
            (click)="nextStep()"
            *ngIf="currentStep < maxStep"
          >
            <span>Siguiente</span>
            <span class="material-symbols-rounded">arrow_forward</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
