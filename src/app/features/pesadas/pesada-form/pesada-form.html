<div class="ux-scope">
  <div class="card ux-card p-3">
    <!-- HEADER -->
    <div class="ux-form-header">
      <div>
        <h5 class="ux-title mb-1">Ticket de balanza - Nuevo</h5>
        <p class="ux-subtitle mb-0">
          Registro paso a paso del ticket de balanza, documentos relacionados,
          datos de transporte y pesadas asociadas.
        </p>

        <!-- Estado cabecera -->
        <div class="mt-2">
          <span class="badge" [ngClass]="headerSaved ? 'text-bg-success' : 'text-bg-secondary'">
            {{ headerSaved ? 'Encabezado guardado' : 'Encabezado pendiente' }}
          </span>

          <span class="ms-2 text-muted" *ngIf="headerSaved && headerTicketId">
            ID: {{ headerTicketId }}
          </span>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-start">
        <!-- ✅ BOTÓN X -->
        <button
          type="button"
          class="ux-icon-btn ux-icon-btn--danger"
          title="Reiniciar ticket (borrar avance)"
          (click)="resetDraftConfirm()"
          [disabled]="!hasDraft || isSavingHeader || isSavingFull"
        >
          <span class="material-symbols-rounded">close</span>
        </button>

        <!-- Guardar ticket final (solo en paso 5) -->
        <button
          type="button"
          class="ux-btn ux-btn--primary"
          *ngIf="currentStep === maxStep"
          (click)="guardarTicketCompleto()"
          [disabled]="isSavingFull"
        >
          <ng-container *ngIf="!isSavingFull">
            <span class="material-symbols-rounded">done_all</span>
            <span>Guardar ticket</span>
          </ng-container>

          <ng-container *ngIf="isSavingFull">
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            <span>Guardando…</span>
          </ng-container>
        </button>
      </div>
    </div>

    <!-- STEPPER -->
    <app-stepper-nav
      class="mb-3"
      [steps]="steps"
      [currentStep]="currentStep"
      (stepChange)="onStepChange($event)"
    ></app-stepper-nav>

    <!-- FORM -->
    <form [formGroup]="ticketForm" novalidate autocomplete="off" class="step-form">
      <div class="step-content" [ngSwitch]="currentStep">

        <!-- PASO 1 -->
        <div *ngSwitchCase="1" class="step-panel">
          <app-paso-datos-operacion
            [formGroup]="datosOperacion"
            [locked]="headerSaved"
            [minFechaEmision]="minFechaEmision"
            [maxFechaEmision]="maxFechaEmision"
            (stationsReady)="onStationsReady($event)"
            (operationChange)="onOperationChange($event)"
          ></app-paso-datos-operacion>
        </div>

        <!-- PASO 2 -->
        <div *ngSwitchCase="2" class="step-panel">
          <app-paso-origen-destino
            [formGroup]="origenDestino"
            [originStations]="originStations"
            [destinationStations]="destinationStations"
            [locked]="headerSaved"
          ></app-paso-origen-destino>
        </div>

        <!-- PASO 3 -->
        <div *ngSwitchCase="3" class="step-panel">
          <app-paso-documentos
            [operationId]="operationIdSelected"
            [locked]="headerSaved"
            [documentos]="documentos"
            (documentosChange)="onDocumentosChange($event)"
          ></app-paso-documentos>
        </div>

        <!-- PASO 4 -->
        <div *ngSwitchCase="4" class="step-panel">
          <app-paso-transporte
            [formGroup]="transporte"
            [locked]="headerSaved"
          ></app-paso-transporte>

          <div class="alert alert-info mt-3 mb-0" *ngIf="!headerSaved">
            <strong>Importante:</strong> al presionar <b>Siguiente</b>, se guardará la cabecera del ticket.
            Luego se habilitará el Paso 5.
          </div>

          <div class="alert alert-success mt-3 mb-0" *ngIf="headerSaved">
            <strong>Listo:</strong> la cabecera ya fue guardada. Puedes continuar al Paso 5.
          </div>
        </div>

        <!-- PASO 5 -->
        <div *ngSwitchCase="5" class="step-panel">
          <!-- <app-paso-detalle-ticket
            [formGroup]="detalleTicket"
            [pesadas]="pesadas"
            [totales]="totalesPesadas"
            [productos]="productosMock"
            [balanzas]="balanzasMock"
            [locked]="isSavingFull || isSavingHeader"
            (pesadasChange)="onPesadasChange($event)"
            (ajusteChange)="onChangeAjusteKg()"
          ></app-paso-detalle-ticket> -->

          <app-paso-detalle-ticket
          [formGroup]="detalleTicket"
          [operationId]="operationIdSelected"

          [pesadas]="pesadas"
          [totales]="totalesPesadas"
          [balanzas]="balanzasMock"
          [locked]="isSavingFull || isSavingHeader"
          (pesadasChange)="onPesadasChange($event)"
          (ajusteChange)="onChangeAjusteKg()"
        ></app-paso-detalle-ticket>



        </div>

        <div *ngSwitchDefault class="step-panel">
          <p class="mb-0">Selecciona un paso para comenzar.</p>
        </div>
      </div>

      <!-- Navegación -->
      <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <button
          type="button"
          class="ux-btn ux-btn--blue"
          (click)="prevStep()"
          [disabled]="currentStep === 1 || isSavingHeader"
        >
          <span class="material-symbols-rounded">arrow_back</span>
          <span>Volver</span>
        </button>

        <button
          type="button"
          class="ux-btn ux-btn--green"
          (click)="nextStep()"
          *ngIf="currentStep < maxStep"
          [disabled]="isSavingHeader"
        >
          <ng-container *ngIf="currentStep !== 4">
            <span>Siguiente</span>
            <span class="material-symbols-rounded">arrow_forward</span>
          </ng-container>

          <ng-container *ngIf="currentStep === 4">
            <ng-container *ngIf="!isSavingHeader">
              <span>{{ headerSaved ? 'Continuar' : 'Guardar encabezado y continuar' }}</span>
              <span class="material-symbols-rounded">arrow_forward</span>
            </ng-container>

            <ng-container *ngIf="isSavingHeader">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              <span>Guardando…</span>
            </ng-container>
          </ng-container>
        </button>
      </div>
    </form>
  </div>
</div>
