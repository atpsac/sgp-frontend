<div class="uxf-modal">
  <!-- Cerrar -->
  <button
    type="button"
    class="uxf-close"
    aria-label="Cerrar"
    (click)="close()"
    [disabled]="loading || processing"
    title="Cerrar"
  >
    ×
  </button>

  <!-- Header -->
  <div class="uxf-header">
    <h3 class="uxf-title">{{ title }}</h3>
    <p class="uxf-sub">{{ subtitle }}</p>
  </div>

  <!-- Form -->
  <form [formGroup]="form" (ngSubmit)="save()">
    <div class="uxf-grid">
      <!-- Columna izquierda -->
      <div class="uxf-col-main">
        <!-- Producto -->
        <div class="uxf-field">
          <label class="uxf-label" for="producto">
            Producto <span class="req">*</span>
          </label>

          <div class="uxf-select">
            <select
              id="producto"
              class="uxf-control"
              formControlName="ProductoId"
              [class.is-invalid]="f['ProductoId'].touched && f['ProductoId'].invalid"
            >
              <option [ngValue]="null" disabled>Selecciona un producto…</option>
              <option *ngFor="let p of productoOptions" [ngValue]="p.id">
                {{ p.nombre }}
              </option>
            </select>

            <span class="material-symbols-rounded uxf-select__icon" aria-hidden="true">expand_more</span>
          </div>

          <div class="uxf-hint-row">
            <div class="uxf-error" *ngIf="f['ProductoId'].touched && f['ProductoId'].hasError('required')">
              El producto es obligatorio.
            </div>
          </div>
        </div>

        <!-- Balanza / Peso bruto -->
        <div class="uxf-row-2">
          <!-- Balanza -->
          <div class="uxf-col-6">
            <div class="uxf-field">
              <label class="uxf-label" for="balanza">
                Balanza <span class="req">*</span>
              </label>

              <div class="uxf-select">
                <select
                  id="balanza"
                  class="uxf-control"
                  formControlName="BalanzaId"
                  [disabled]="lockScaleSelect"
                  [class.is-invalid]="f['BalanzaId'].touched && f['BalanzaId'].invalid"
                >
                  <option [ngValue]="null" disabled>Selecciona una balanza…</option>
                  <option *ngFor="let b of balanzaOptions" [ngValue]="b.id">
                    {{ b.nombre }}
                  </option>
                </select>

                <span class="material-symbols-rounded uxf-select__icon" aria-hidden="true">expand_more</span>
              </div>

              <div class="uxf-hint-row">
                <div class="uxf-error" *ngIf="f['BalanzaId'].touched && f['BalanzaId'].hasError('required')">
                  La balanza es obligatoria.
                </div>
                <div class="uxf-hint" *ngIf="!f['BalanzaId'].value">
                  Selecciona una balanza y luego presiona <b>Iniciar pesada</b>.
                </div>
              </div>
            </div>
          </div>

          <!-- Peso bruto (readonly) -->
          <div class="uxf-col-6">
            <div class="uxf-field">
              <label class="uxf-label" for="pesoBruto">
                Peso bruto (kg) <span class="req">*</span>
              </label>

              <input
                id="pesoBruto"
                type="number"
                class="uxf-control"
                formControlName="PesoBruto"
                readonly
              />

              <div class="uxf-hint-row">
                <div class="uxf-error" *ngIf="statusUI === 'CONECTADO' && !isStable">
                  Espera a que el peso sea estable para poder guardar.
                </div>

                <div class="uxf-error" *ngIf="statusUI === 'DESCONECTADO' && f['BalanzaId'].value">
                  Balanza desconectada. Presiona <b>Iniciar pesada</b>.
                </div>

                <div class="uxf-error" *ngIf="statusUI === 'ERROR'">
                  Error al leer la balanza. Revisa la configuración del dispositivo.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="uxf-field">
          <label class="uxf-label" for="observaciones">Observaciones</label>
          <textarea
            id="observaciones"
            class="uxf-control uxf-control--area"
            formControlName="Observaciones"
            rows="3"
            placeholder="Comentarios adicionales sobre la pesada"
          ></textarea>
        </div>
      </div>

      <!-- Columna derecha: visor -->
      <div class="uxf-col-visor">
        <div
          class="uxf-visor"
          [class.uxf-visor--stable]="isStable"
          [class.uxf-visor--unstable]="!isStable"
          [class.uxf-visor--busy]="processing"
        >
          <!-- TOP: nombre balanza (izq) + estado (der) -->
          <div class="uxf-visor__top">
            <div class="uxf-visor__scale">
              {{ currentScaleName || 'Sin balanza seleccionada' }}
            </div>

            <div class="uxf-visor__status">
              <span class="badge" [ngClass]="statusClass">{{ statusLabel }}</span>
            </div>
          </div>

          <span class="uxf-visor-label">PESO ACTUAL</span>

          <!-- Procesando -->
          <div class="uxf-processing" *ngIf="processing">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span>Procesando…</span>
          </div>

          <!-- valor -->
          <div class="uxf-visor-value" *ngIf="!processing">
            {{ pesoActual | number : '1.2-2' }}
            <span class="uxf-visor-unit">kg</span>
          </div>

          <!-- Botón iniciar/detener -->
          <button
            type="button"
            class="uxf-btn uxf-btn--start"
            (click)="toggleWeighing()"
            [disabled]="startBtnDisabled"
          >
            <span class="material-symbols-rounded" aria-hidden="true">
              {{ statusUI === 'CONECTADO' ? 'stop_circle' : 'play_circle' }}
            </span>
            {{ startBtnText }}
          </button>

          <div class="uxf-stable" *ngIf="!processing && statusUI === 'CONECTADO'">
            Estable:
            <b [class.ok]="isStable" [class.bad]="!isStable">{{ isStable ? 'Sí' : 'No' }}</b>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="uxf-footer">
        <button
          type="button"
          class="uxf-btn uxf-btn--ghost"
          (click)="close()"
          [disabled]="loading || loadingData || processing"
        >
          Cancelar
        </button>

        <button
          type="submit"
          class="uxf-btn uxf-btn--primary"
          [disabled]="loading || loadingData || processing || form.invalid || !canSave()"
        >
          <ng-container *ngIf="!loading">Guardar</ng-container>
          <ng-container *ngIf="loading">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Guardando…
          </ng-container>
        </button>
      </div>
    </div>
  </form>
</div>
