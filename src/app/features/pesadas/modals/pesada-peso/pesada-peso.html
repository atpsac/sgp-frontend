<div class="uxf-modal">
  <!-- Cerrar -->
  <button
    type="button"
    class="uxf-close"
    aria-label="Cerrar"
    (click)="close()"
    [disabled]="loading || processing"
    title="Cerrar"
  >
    ×
  </button>

  <!-- Header -->
  <div class="uxf-header">
    <h3 class="uxf-title">{{ title }}</h3>
    <p class="uxf-sub">{{ subtitle }}</p>
  </div>

  <!-- Form -->
  <form [formGroup]="form" (ngSubmit)="save()">
    <div class="uxf-grid">
      <!-- Columna izquierda -->
      <div class="uxf-col-main">

        <!-- Balanza / Estado -->
        <div class="uxf-row-2">
          <!-- Balanza -->
          <div class="uxf-col-6">
            <div class="uxf-field">
              <label class="uxf-label" for="balanza">
                Balanza <span class="req">*</span>
              </label>

              <div class="uxf-select">
                <select
                  id="balanza"
                  class="uxf-control"
                  formControlName="BalanzaId"
                  [disabled]="lockScaleSelect"
                  [class.is-invalid]="f['BalanzaId'].touched && f['BalanzaId'].invalid"
                >
                  <option [ngValue]="null">
                    {{ loadingData ? 'Cargando balanzas…' : 'Selecciona una balanza…' }}
                  </option>

                  <option *ngFor="let b of balanzaOptions" [ngValue]="b.id">
                    {{ b.nombre }}
                  </option>
                </select>

                <span class="material-symbols-rounded uxf-select__icon" aria-hidden="true">
                  expand_more
                </span>
              </div>

              <div class="uxf-hint-row">
                <div
                  class="uxf-error"
                  *ngIf="f['BalanzaId'].touched && f['BalanzaId'].hasError('required')"
                >
                  La balanza es obligatoria.
                </div>

                <div class="uxf-hint" *ngIf="!f['BalanzaId'].value && !loadingData">
                  Selecciona una balanza y luego presiona <b>Iniciar pesada</b>.
                </div>

                <div class="uxf-hint" *ngIf="loadingData">
                  Obteniendo balanzas operativas del ticket…
                </div>
              </div>
            </div>
          </div>

          <!-- Estado de balanza -->
          <div class="uxf-col-6">
            <div class="uxf-field">
              <label class="uxf-label" for="BalanzaEstado">
                Estado de balanza <span class="req">*</span>
              </label>

              <input
                id="BalanzaEstado"
                type="text"
                class="uxf-control"
                formControlName="BalanzaEstado"
                readonly
              />
            </div>
          </div>
        </div>

        <!-- Tipo pesada REAL / Peso bruto -->
        <div class="uxf-row-2">
          <!-- Tipo pesada (backend) -->
          <div class="uxf-col-6">
            <div class="uxf-field">
              <label class="uxf-label" for="weighingType">
                Tipo_pesada <span class="req">*</span>
              </label>

              <div class="uxf-select">
                <select
                  id="weighingType"
                  class="uxf-control"
                  formControlName="WeighingTypeId"
                  [disabled]="loading || loadingData || processing || loadingWeighingTypes || !f['BalanzaId'].value"
                  [class.is-invalid]="f['WeighingTypeId'].touched && f['WeighingTypeId'].invalid"
                >
                  <option [ngValue]="null">
                    {{
                      !f['BalanzaId'].value
                        ? 'Selecciona una balanza primero…'
                        : (loadingWeighingTypes ? 'Cargando tipos…' : 'Selecciona un tipo…')
                    }}
                  </option>

                  <option *ngFor="let t of weighingTypeOptions" [ngValue]="t.weighingTypeId">
                    {{ t.name }} ({{ t.code }})
                  </option>
                </select>

                <span class="material-symbols-rounded uxf-select__icon" aria-hidden="true">
                  expand_more
                </span>
              </div>

              <div class="uxf-hint-row">
                <div
                  class="uxf-error"
                  *ngIf="f['WeighingTypeId'].touched && f['WeighingTypeId'].hasError('required')"
                >
                  El tipo de pesada es obligatorio.
                </div>

                <div class="uxf-hint" *ngIf="selectedWeighingType?.description">
                  {{ selectedWeighingType?.description }}
                </div>

                <div class="uxf-hint" *ngIf="isSoloPallet">
                  En <b>SOLO PALLET</b> no aplica seleccionar producto.
                </div>
              </div>
            </div>
          </div>

          <!-- Peso bruto (readonly) -->
          <div class="uxf-col-6">
            <div class="uxf-field">
              <label class="uxf-label" for="pesoBruto">
                Peso bruto (kg) <span class="req">*</span>
              </label>

              <input
                id="pesoBruto"
                type="number"
                class="uxf-control"
                formControlName="PesoBruto"
                readonly
              />

              <div class="uxf-hint-row">
                <div class="uxf-error" *ngIf="statusUI === 'CONECTADO' && !isStable">
                  Espera a que el peso sea estable para poder guardar.
                </div>

                <div
                  class="uxf-error"
                  *ngIf="statusUI === 'DESCONECTADO' && f['BalanzaId'].value"
                >
                  Balanza desconectada. Presiona <b>Iniciar pesada</b>.
                </div>

                <div class="uxf-error" *ngIf="statusUI === 'ERROR'">
                  Error al leer la balanza. Revisa la configuración del dispositivo.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Producto -->
        <div class="uxf-field">
          <label class="uxf-label" for="producto">
            Producto
            <span class="req" *ngIf="!isSoloPallet">*</span>
          </label>

          <div class="uxf-select">
            <select
              id="producto"
              class="uxf-control"
              formControlName="ProductoId"
              [disabled]="isSoloPallet"
              [class.is-invalid]="
                !isSoloPallet &&
                f['ProductoId'].touched &&
                f['ProductoId'].invalid
              "
            >
              <option [ngValue]="null">Selecciona un producto…</option>
              <option *ngFor="let p of productoOptions" [ngValue]="p.id">
                {{ p.nombre }}
              </option>
            </select>

            <span class="material-symbols-rounded uxf-select__icon" aria-hidden="true">
              expand_more
            </span>
          </div>

          <div class="uxf-hint-row">
            <div
              class="uxf-error"
              *ngIf="
                !isSoloPallet &&
                f['ProductoId'].touched &&
                f['ProductoId'].hasError('required')
              "
            >
              El producto es obligatorio.
            </div>

            <div class="uxf-hint" *ngIf="isSoloPallet">
              Producto deshabilitado por el tipo de pesada.
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="uxf-field">
          <label class="uxf-label" for="observaciones">Observaciones</label>
          <textarea
            id="observaciones"
            class="uxf-control uxf-control--area"
            formControlName="Observaciones"
            rows="3"
            placeholder="Comentarios adicionales sobre la pesada"
          ></textarea>
        </div>
      </div>

      <!-- Columna derecha: visor -->
      <div class="uxf-col-visor">
        <div
          class="uxf-visor"
          [class.uxf-visor--stable]="isStable"
          [class.uxf-visor--unstable]="!isStable"
          [class.uxf-visor--busy]="processing"
        >
          <!-- TOP -->
          <div class="uxf-visor__top">
            <div class="uxf-visor__scale">
              {{ currentScaleName || 'Sin balanza seleccionada' }}
            </div>

            <div class="uxf-visor__status">
              <span class="badge" [ngClass]="statusClass">{{ statusLabel }}</span>
            </div>
          </div>

          <span class="uxf-visor-label">PESO ACTUAL</span>

          <!-- Procesando -->
          <div class="uxf-processing" *ngIf="processing">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span>Procesando…</span>
          </div>

          <!-- valor -->
          <div class="uxf-visor-value" *ngIf="!processing">
            {{ pesoActual | number : '1.2-2' }}
            <span class="uxf-visor-unit">kg</span>
          </div>

          <!-- Botón iniciar -->
          <button
            type="button"
            class="uxf-btn uxf-btn--start"
            (click)="startWeighing()"
            [disabled]="startBtnDisabled"
          >
            <span class="material-symbols-rounded" aria-hidden="true">
              {{ startBtnIcon }}
            </span>
            {{ startBtnText }}
          </button>

          <div class="uxf-stable" *ngIf="!processing && statusUI === 'CONECTADO'">
            Estable:
            <b [class.ok]="isStable" [class.bad]="!isStable">{{ isStable ? 'Sí' : 'No' }}</b>
          </div>

          <div class="uxf-hint" *ngIf="statusUI === 'CONECTADO'">
            La pesada queda bloqueada hasta <b>Guardar</b> o <b>Cancelar</b>.
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="uxf-footer">
        <button
          type="button"
          class="uxf-btn uxf-btn--ghost"
          (click)="close()"
          [disabled]="loading || loadingData || processing || loadingWeighingTypes"
        >
          Cancelar
        </button>

        <button
          type="submit"
          class="uxf-btn uxf-btn--primary"
          [disabled]="loading || loadingData || processing || loadingWeighingTypes || form.invalid || !canSave()"
        >
          <ng-container *ngIf="!loading">Guardar</ng-container>
          <ng-container *ngIf="loading">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Guardando…
          </ng-container>
        </button>
      </div>
    </div>
  </form>
</div>
